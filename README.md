# 高機能画像編集ツールボックス (Image Editor Toolbox)

このプロジェクトは、Webブラウザ上で高度な画像編集を実現するためのReactコンポーネント群です。以下の3つの主要機能を提供します。

1.  **画像クロップ機能:** 画像を四角形または円形（楕円形）に切り抜きます。
2.  **PDF生成機能:** 複数の画像をまとめて1つのPDFファイルに変換します。
3.  **画像結合機能:** 複数の画像をキャンバス上に自由に配置・合成し、1枚の画像として出力します。

すべての機能には、`Socket.IO`を利用した**リアルタイム同期機能**が組み込まれており、複数のユーザーが同じ画面を共有し、共同で編集作業を行うことが可能です。

## ①主な特徴

* **多機能なインブラウザ編集:** 画像のアップロードから編集、ダウンロードまで、すべてクライアントサイドのブラウザで完結します。
* **直感的なUI/UX:** ドラッグ＆ドロップ、マウス操作による直感的な編集が可能です。ズーム、パン、スナップガイドなどの補助機能も充実しています。
* **リアルタイム共同編集:** `Socket.IO`を通じて、キャンバスや画像リストの状態がリアルタイムで他のクライアントと同期されます。
* **モバイルフレンドリー:** PCだけでなく、スマートフォンやタブレットのタッチ操作（ピンチズーム、二本指パンなど）にも対応しています。
* **高画質・高精度な出力:** 表示上のスケールに依存せず、元画像の解像度を活かしたクロップや画像生成を行います。

## ②機能詳細

### 1. 画像クロップ機能 (`CropperComponent.js`)

指定した画像の一部を、高画質を維持したまま切り抜くためのコンポーネントです。

* **画像アップロード:**
    * ローカルから画像ファイルを1つ選択し、キャンバスに背景として読み込みます。
    * 画像の縦横比を維持したまま、キャンバス中央に最適サイズで表示します。
* **クロップ形状の選択:**
    * `四角形 (Rect)` と `円 (Circle)` の2種類のクロップ形状を選択できます。
* **直感的な範囲指定:**
    * マウス（または指）をドラッグすることで、クロップ範囲を自由に描画できます。
    * 描画したクロップ枠は、移動したり、コントロールハンドルを使ってリサイズしたりすることが可能です。
* **精密な枠調整機能:**
    * ボタン操作により、クロップ枠の上下左右の辺を1px単位で拡大・縮小できます。
    * 円形の場合、この操作を行うと`楕円 (Ellipse)`に変形し、より自由な調整が可能になります。
* **範囲制限:**
    * クロップ枠が、読み込んだ背景画像の範囲外にはみ出さないように自動で制限されます。
* **高解像度クロップ:**
    * `クロップ実行` ボタンを押すと、画面表示用の縮小された画像ではなく、**元画像のフル解像度**を使用して処理が行われます。
    * 内部的にオフスクリーンの`fabric.Canvas`を元画像のサイズで作成し、クリッピングを行うことで、画質の劣化を最小限に抑えています。
* **プレビューとダウンロード:**
    * クロップ結果は画面下部にプレビュー表示されます。
    * 結果画像をPNG形式でダウンロードできます。
* **リアルタイム同期:**
    * 背景画像の読み込み状態と、クロップ枠の位置・サイズ・形状が同期されます。
    * `autoSync`を意図的にオフにし、同期先のクライアントでクロップ枠が意図せず消えることを防いでいます。

### 2. PDF生成機能 (`PdfComponent.js`)

複数の画像をアップロードし、順番を並べ替えて1つのPDFファイルとしてまとめるコンポーネントです。

* **複数画像の同時アップロード:**
    * 複数の画像ファイルを一度に選択してアップロードできます。
* **画像圧縮とプレビュー:**
    * アップロード時にクライアントサイドで画像を圧縮し、サーバー負荷とプレビュー表示の高速化を図っています。
    * 画像はサムネイル一覧として表示され、ファイル名とページ番号が確認できます。
* **ドラッグ＆ドロップによる並べ替え:**
    * `@dnd-kit`ライブラリを使用し、ドラッグ＆ドロップで直感的に画像の順序（PDFのページ順）を変更できます。
* **画像の選択と削除:**
    * サムネイルをクリックして画像を選択し、選択した画像をまとめて削除できます。
* **PDF生成とダウンロード:**
    * `pdf-lib`ライブラリを使用して、クライアントサイドでPDFを生成します。
    * 各画像が1ページずつ、A4用紙の幅に合わせて配置されたPDFファイルが作成されます。
    * `file-saver`を利用して、生成されたPDFを`images.pdf`としてダウンロードします。
* **プログレス表示:**
    * 画像のアップロード時とPDF生成時には、処理の進捗状況がパーセンテージで表示され、ユーザー体験を向上させています。
* **リアルタイム同期:**
    * 画像リスト（画像の順序、追加、削除）の状態がリアルタイムで同期され、複数人でのリスト編集が可能です。

### 3. 画像結合機能 (`CombinerComponent.js`)

複数の画像をキャンバス上に自由に配置し、デザイン・レイアウトを作成して1枚の画像として書き出すための多機能コンポーネントです。

* **自由な画像配置:**
    * 複数の画像をキャンバスに追加し、それぞれを自由に移動、リサイズできます。
* **高度なキャンバス操作:**
    * **ズーム:** マウスホイールのスクロール、またはモバイルでのピンチ操作でキャンバスを拡大・縮小できます。
    * **パン:** `Alt`キーを押しながらドラッグ、またはモバイルでの二本指ドラッグで、キャンバス全体を掴んで移動できます。
* **スナップ＆ガイドライン機能:**
    * オブジェクトを移動・リサイズする際に、他のオブジェクトの辺や中心に近づくと自動で吸着（スナップ）します。
    * スナップした際には、どの辺が揃っているかを示す**赤いガイドライン**が動的に表示され、精密なレイアウト作業をサポートします。
    * ガイドラインの太さはスライダーで調整可能です。
* **Undo/Redo機能:**
    * オブジェクトの追加、移動、リサイズ、削除など、ほぼすべての操作履歴がスタックに保存され、`Undo`（元に戻す）と`Redo`（やり直し）が可能です。
* **余白なしダウンロード:**
    * キャンバス全体ではなく、配置された**画像群が存在する最小矩形領域のみを自動で計算**し、不要な余白をクロップしてPNG画像として書き出します。
* **便利なUI補助機能:**
    * **サイズ表示:** オブジェクトを選択すると、そのオブジェクトの幅と高さ（複数選択の場合は合計のバウンディングボックスサイズ）がリアルタイムで表示されます。
    * **ズーム率表示:** 現在のキャンバスのズーム率がパーセンテージで表示されます。
    * **画像リストからのフォーカス:** キャンバス下部に表示される画像一覧のサムネイルをクリックすると、その画像がキャンバスの中央に来るようにビューポートが自動で移動します。
* **リアルタイム同期:**
    * キャンバス上のすべての画像オブジェクト（位置、サイズ、角度、重なり順など）の状態がシリアライズされ、リアルタイムで同期されます。

## ③アーキテクチャと共通機能

### リアルタイム同期 (`syncService.js`)

本プロジェクトの共同編集機能の中核を担うサービスです。`Socket.IO`を用いたリアルタイム通信ロジックをカプセル化し、各コンポーネントから簡単に利用できるように設計されています。

* **データのシリアライズ/復元:**
    * `serializeImages`: `Fabric.js`のキャンバス上のオブジェクト（画像、背景）の状態を、転送可能なJSON形式のデータに変換（シリアライズ）します。各オブジェクトの位置、サイズ、角度、画像ソース（Data URL）などの情報を保持します。
    * `restoreImages`: シリアライズされたデータを受け取り、他のクライアントのキャンバス上にオブジェクトを再構築（復元）します。
* **データ転送のチャンク化:**
    * 画像データを含むJSONはサイズが大きくなる可能性があるため、一度に送信できるデータ量の上限を超える場合があります。
    * `sendChunk`関数は、大きなデータを約900KBの小さな塊（チャンク）に分割して送信します。
    * `receiveChunk`関数は、分割されて送られてきたチャンクを順番通りに結合し、元のデータに復元します。これにより、大きなデータも安定して送受信できます。
* **汎用的なセットアップ関数:**
    * `setupSync`: `Fabric.js`キャンバスの同期を初期化するための汎用関数です。
    * `setupListSync`: `PdfComponent`のような、画像リストの同期に特化した関数です。

## ④技術スタック

* **フロントエンド:** [React](https://reactjs.org/) (Hooks)
* **グラフィック/キャンバス操作:** [Fabric.js](http://fabricjs.com/)
* **PDF生成:** [pdf-lib](https://pdf-lib.js.org/)
* **ドラッグ＆ドロップ:** [@dnd-kit](https://dndkit.com/)
* **画像圧縮:** [browser-image-compression](https://github.com/Donaldcwl/browser-image-compression)
* **ファイルダウンロード:** [file-saver](https://github.com/eligrey/FileSaver.js/)
* **リアルタイム通信:** [Socket.IO](https://socket.io/) Client
